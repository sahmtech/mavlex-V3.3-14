/**
 * POS Real-time Product Addition
 */

// Global cache for product data
window.POS_InstantCache = {
    products: {},
    brands: {},
    taxes: {},
    sub_units: {},
    settings: {},
    business: {},
    permissions: {},
    common_settings: {},
    enabled_modules: [],
    group_prices: {},
    lot_numbers: {},
    initialized: false,

    initialize: function(locationId) {
        if (this.initialized) return Promise.resolve();

        if (!window.POS_APP_SETTINGS || !window.POS_APP_SETTINGS.enable_instant_pos) {
            return Promise.resolve();
        }

        this.showLoadingIndicator();
        this.disablePosInterface();
        
        const requestData = { location_id: locationId };
        
        if (window.POS_APP_SETTINGS && window.POS_APP_SETTINGS.pos_max_cached_products && window.POS_APP_SETTINGS.pos_max_cached_products > 0) {
            requestData.limit = window.POS_APP_SETTINGS.pos_max_cached_products;
        }
        
        return $.ajax({
            url: '/sells/pos/get-product-data-for-instant-row',
            method: 'GET',
            data: requestData,
            dataType: 'json'
        }).done((response) => {
            this.products = response.products || {};
            this.brands = response.brands || {};
            this.taxes = response.taxes || {};
            this.sub_units = response.sub_units || {};
            this.settings = response.pos_settings || {};
            this.business = response.business_details || {};
            this.permissions = response.permissions || {};
            this.common_settings = response.common_settings || {};
            this.enabled_modules = response.enabled_modules || [];
            this.allowed_group_prices = response.allowed_group_prices || [];
            this.group_prices = response.group_prices || {};
            this.lot_numbers = response.lot_numbers || {};
            this.initialized = true;
            this.hideLoadingIndicator();
            this.enablePosInterface();
        }).fail((xhr) => {
            console.error('Failed to initialize POS Instant Cache:', xhr);
            this.hideLoadingIndicator();
            this.enablePosInterface();
            this.showErrorMessage(window.POS_APP_SETTINGS?.messages?.failed_to_load_cache || 'Failed to load product cache. POS functionality may be limited.');
        });
    },

    getProduct: function(variationId) {
        return this.products[variationId] || null;
    },

    getGroupPrice: function(variationId, priceGroupId) {
        if (this.group_prices[variationId] && this.group_prices[variationId][priceGroupId]) {
            return this.group_prices[variationId][priceGroupId].price_inc_tax;
        }
        return null;
    },

    getCurrentPriceGroup: function() {
        const priceGroupSelect = $('#price_group');
        if (priceGroupSelect.length && priceGroupSelect.val()) {
            return priceGroupSelect.val();
        }
        return null;
    },

    getLotNumbers: function(variationId) {
        return this.lot_numbers[variationId] || [];
    },

    searchProducts: function(term, searchFields = ['name', 'sku']) {
        if (!term || term.length < 2) return [];
        
        const searchTerm = term.toLowerCase();
        const results = [];
        
        Object.values(this.products).forEach(product => {
            let matches = false;
            
            if (searchFields.includes('name') && product.product_name.toLowerCase().includes(searchTerm)) {
                matches = true;
            }
            
            if (searchFields.includes('sku') && product.sub_sku.toLowerCase().includes(searchTerm)) {
                matches = true;
            }
            
            if (matches) {
                const brandName = product.brand_id && this.brands[product.brand_id] ? this.brands[product.brand_id] : '';
                const productName = product.product_name + (brandName ? ' ' + brandName : '');
                
                let selling_price = parseFloat(product.sell_price_inc_tax || product.default_sell_price);
                
                // Get group price if price group is selected
                const currentPriceGroup = this.getCurrentPriceGroup();
                let variation_group_price = null;
                if (currentPriceGroup) {
                    variation_group_price = this.getGroupPrice(product.variation_id, currentPriceGroup);
                }
                
                results.push({
                    variation_id: product.variation_id,
                    name: productName,
                    type: product.product_type === 'single' ? 'single' : 'variable',
                    variation: product.variation_name !== 'DUMMY' ? product.variation_name : '',
                    sub_sku: product.sub_sku,
                    selling_price: selling_price,
                    variation_group_price: variation_group_price,
                    enable_stock: product.enable_stock,
                    qty_available: product.qty_available === null ? 999999 : parseFloat(product.qty_available || 0),
                    unit: product.unit,
                    purchase_line_id: null,
                    lot_number: null
                });
            }
        });
        
        results.sort((a, b) => {
            const aExact = a.name.toLowerCase().startsWith(searchTerm) || a.sub_sku.toLowerCase().startsWith(searchTerm);
            const bExact = b.name.toLowerCase().startsWith(searchTerm) || b.sub_sku.toLowerCase().startsWith(searchTerm);
            
            if (aExact && !bExact) return -1;
            if (!aExact && bExact) return 1;
            return a.name.localeCompare(b.name);
        });
        
        return results.slice(0, 20); 
    },

    refreshCache: function(locationId) {
        this.showRefreshIndicator();
        
        const requestData = { location_id: locationId };
        
        if (window.POS_APP_SETTINGS && window.POS_APP_SETTINGS.pos_max_cached_products && window.POS_APP_SETTINGS.pos_max_cached_products > 0) {
            requestData.limit = window.POS_APP_SETTINGS.pos_max_cached_products;
        }
        
        return $.ajax({
            url: '/sells/pos/get-product-data-for-instant-row',
            method: 'GET',
            data: requestData,
            dataType: 'json'
        }).done((response) => {
            this.products = response.products || {};
            this.brands = response.brands || {};
            this.taxes = response.taxes || {};
            this.sub_units = response.sub_units || {};
            this.settings = response.pos_settings || {};
            this.business = response.business_details || {};
            this.permissions = response.permissions || {};
            this.common_settings = response.common_settings || {};
            this.enabled_modules = response.enabled_modules || [];
            this.allowed_group_prices = response.allowed_group_prices || [];
            this.group_prices = response.group_prices || {};
            this.lot_numbers = response.lot_numbers || {};
            
            this.hideRefreshIndicator();
        }).fail((xhr) => {
            console.error('Failed to refresh POS Instant Cache:', xhr);
            this.hideRefreshIndicator();
        });
    },

    forceRefresh: function() {
        const locationId = $('input#location_id').val();
        if (locationId) {
            // Don't reset if we're restoring customer after cart clear
            if (!window.pos_restoring_customer) {
                reset_pos_form();
            } else {
                console.log('Skipping force refresh reset - customer restoration in progress');
            }
            return this.refreshCache(locationId);
            
        } else {
            console.error('No location ID found for cache refresh');
            return Promise.reject('No location ID');
        }
    },

    showLoadingIndicator: function() {
        this.hideLoadingIndicator();
        
        const loadingHtml = `
            <div id="pos-cache-loader" style="
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.7);
                z-index: 9999;
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-size: 18px;
            ">
                <div style="text-align: center;">
                    <div style="margin-bottom: 20px;">
                        <i class="fa fa-spinner fa-spin fa-3x"></i>
                    </div>
                    <div>${window.POS_APP_SETTINGS?.messages?.loading_products || 'Loading Products...'}</div>
                    <div style="font-size: 14px; margin-top: 10px; opacity: 0.8;">
                        ${window.POS_APP_SETTINGS?.messages?.please_wait_while_products_load || 'Please wait while products load'}
                    </div>
                </div>
            </div>
        `;
        
        $('body').append(loadingHtml);
    },

    hideLoadingIndicator: function() {
        $('#pos-cache-loader').remove();
    },

    disablePosInterface: function() {
        // Disable search input
        $('#search_product').prop('disabled', true);
        
        // Disable other interactive elements
        $('.pos-processing, .pos-controls, .btn').not('#pos-cache-loader *').prop('disabled', true);
    },

    enablePosInterface: function() {
        // Re-enable search input
        $('#search_product').prop('disabled', false);
        
        // Re-enable other elements
        $('.pos-processing, .pos-controls, .btn').prop('disabled', false);
    },

    showErrorMessage: function(message) {
        if (typeof toastr !== 'undefined') {
            toastr.error(message);
        } else {
            alert(message);
        }
    },

    showRefreshIndicator: function() {
        this.hideRefreshIndicator();
        
        const refreshHtml = `
            <div id="pos-cache-refresh" style="
                position: fixed;
                top: 20px;
                right: 20px;
                background: var(--primary-color);
                color: white;
                padding: 10px 15px;
                border-radius: 5px;
                z-index: 1000;
                font-size: 14px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            ">
                <i class="fa fa-refresh fa-spin"></i> ${window.POS_APP_SETTINGS?.messages?.updating_stock || 'Updating stock...'}
            </div>
        `;
        
        $('body').append(refreshHtml);
    },

    hideRefreshIndicator: function() {
        $('#pos-cache-refresh').fadeOut(300, function() {
            $(this).remove();
        });
    }
};
function clearCart() {
    let cart = $('.cart-details'); 
    cart.empty(); 
    cart.append(`<div>${LANG.no_items_in_cart}</div>`);
}
function reset_pos_form(){
    // Don't reset if we're processing customer group changes
   
    
    console.log('=== RESET_POS_FORM CALLED ===');
    console.log('Form reset called from:', new Error().stack);
    console.log('Products in cart before reset:', $('table#pos_table tbody tr.product_row').length);

	//If on edit page then redirect to Add POS page
	if($('form#edit_pos_sell_form').length > 0){
		setTimeout(function() {
			window.location = $("input#pos_redirect_url").val();
		}, 4000);
		return true;
	}
	
    //reset all repair defects tags
    if ($("#repair_defects").length > 0) {
        tagify_repair_defects.removeAllTags();
    }

	if(pos_form_obj[0]){
		pos_form_obj[0].reset();
	}
	if(sell_form[0]){
		sell_form[0].reset();
	}
	
	// Reset customer group discount
	// window.pos_customer_group_discount = 0;
	// window.pos_selected_customer_data = null;
	
	// Only set default customer if reset is NOT triggered by customer selection
	if (!window.pos_customer_selection_triggered_reset) {
		set_default_customer();
	} else {
		console.log('Skipping set_default_customer() - reset triggered by customer selection');
		// Clear the flag after use
		window.pos_customer_selection_triggered_reset = false;
	}
	set_location();

	$('tr.product_row').remove();
	$('span.total_quantity, span.price_total, span#total_discount, span#order_tax, span#total_payable, span#shipping_charges_amount').text(0);
	$('span.total_payable_span', 'span.total_paying', 'span.balance_due').text(0);

	$('#modal_payment').find('.remove_payment_row').each( function(){
		$(this).closest('.payment_row').remove();
	});

    if ($('#is_credit_sale').length) {
        $('#is_credit_sale').val(0);
    }

	//Reset discount
	__write_number($('input#discount_amount'), $('input#discount_amount').data('default'));
	$('input#discount_type').val($('input#discount_type').data('default'));

	//Reset tax rate
	$('input#tax_rate_id').val($('input#tax_rate_id').data('default'));
	__write_number($('input#tax_calculation_amount'), $('input#tax_calculation_amount').data('default'));

	$('select.payment_types_dropdown').val('cash').trigger('change');
	//todo check - use namespace to avoid triggering customer group handler
    $('#price_group').trigger('change.reset_form');
	
	// Restore customer and price group if customer data exists
	// BUT skip restoration if reset is triggered by AJAX (like from line 1737)
	if (window.pos_selected_customer_data && !window.pos_ajax_triggered_reset) {
		var customerData = window.pos_selected_customer_data;
		console.log('Restoring customer after reset:', customerData.text);
		
		// Set flag to prevent customer selection handler from running during restoration
		window.pos_customer_restoration_in_progress = true;
		
		// Restore customer selection
		var $customerSelect = $('#customer_id');
		if ($customerSelect.find('option[value="' + customerData.id + '"]').length === 0) {
			$customerSelect.append(new Option(customerData.text, customerData.id, false, false));
		}
		$customerSelect.val(customerData.id).trigger('change.select2');
		
		// Restore customer balance display
		$('#advance_balance_text').text(__currency_trans_from_en(customerData.balance || 0), true);
		$('#advance_balance').val(customerData.balance || 0);
		
		// Restore price group based on customer type
		if (customerData.price_calculation_type == 'selling_price_group') {
			$('#price_group').val(customerData.selling_price_group_id);
			$('input#hidden_price_group').val(customerData.selling_price_group_id);
			// Update Select2 display to show the change visually
			$('#price_group').trigger('change.select2');
			console.log('Restored selling price group after reset:', customerData.selling_price_group_id);
		} else if (customerData.price_calculation_type == 'percentage') {
			$('#price_group').val('0');
			$('input#hidden_price_group').val('0');
			// Update Select2 display to show the change visually  
			$('#price_group').trigger('change.select2');
			window.pos_customer_group_discount = Math.abs(parseFloat(customerData.discount_percent)) || 0;
			console.log('Restored percentage discount after reset:', customerData.discount_percent + '%');
		}
		
		console.log('Customer and pricing restored after reset');
		
		// Clear restoration flag after a short delay to allow events to settle
		setTimeout(function() {
			window.pos_customer_restoration_in_progress = false;
		}, 100);
	} else if (window.pos_ajax_triggered_reset) {
		console.log('Skipping customer restoration - reset triggered by AJAX');
		// Clear customer group discount and data for fresh start
		window.pos_customer_group_discount = 0;
		window.pos_selected_customer_data = null;
		console.log('Cleared customer group discount and data after AJAX reset');
		// Clear the AJAX flag after use
		window.pos_ajax_triggered_reset = false;
	}

	//Reset shipping
	__write_number($('input#shipping_charges'), $('input#shipping_charges').data('default'));
	$('input#shipping_details').val($('input#shipping_details').data('default'));
    $('input#shipping_address, input#shipping_status, input#delivered_to', 'input#delivery_person', 'input#delivery_person_modal').val('');
	if($('input#is_recurring').length > 0){
		$('input#is_recurring').iCheck('update');
	};
    if($('#invoice_layout_id').length > 0){
        $('#invoice_layout_id').trigger('change');
    };
    $('span#round_off_text').text(0);

    //repair module extra  fields reset
    if ($('#repair_device_id').length > 0) {
        $('#repair_device_id').val('').trigger('change');
    }

    if ($('#status').length > 0 && $('#status').is(":visible")) {
        $('#status').val('').trigger('change');
    }
    if ($('#transaction_date').length > 0) {
        $('#transaction_date').data("DateTimePicker").date(moment());
    }
    if ($('.paid_on').length > 0) {
        $('.paid_on').data("DateTimePicker").date(moment());
    }
    if ($('#commission_agent').length > 0) {
        $('#commission_agent').val('').trigger('change');
    } 

    //reset contact due
    $('.contact_due_text').find('span').text('');
    $('.contact_due_text').addClass('hide');

    $(document).trigger('sell_form_reset');

    // $('button.cash').prop('disabled', false);
    // $('button.cash').html('Cash');

    localStorage.removeItem('posData');
    localStorage.setItem('posDataCleared', 'true');
    clearCart();
}
window.POS_FormatHelpers = {
    formatCurrency: function(amount) {
        const symbol = POS_InstantCache.business.currency_symbol || '$';
        const precision = parseInt($('#__precision').val()) || 2;
        return symbol + parseFloat(amount).toFixed(precision);
    },
    
    formatQuantity: function(qty) {
        const precision = parseInt($('#__quantity_precision').val()) || 2;
        return parseFloat(qty).toFixed(precision);
    }
};

window.POS_RowGenerator = {
    
    // Helper functions to mimic PHP functions
    asset: function(path) {
        return window.location.origin + path;
    },
    
    num_format: function(number, decimals = 2) {
        return parseFloat(number || 0).toFixed(decimals);
    },
    
    format_quantity: function(quantity) {
        return parseFloat(quantity || 0).toFixed(2);
    },
    
    format_currency: function(amount) {
        const symbol = POS_InstantCache.business.currency_symbol || '$';
        const precision = POS_InstantCache.business.currency_precision || 2;
        return symbol + parseFloat(amount || 0).toFixed(precision);
    },
    
    lang: function(key) {
        if (typeof window.POS_TRANSLATIONS === 'object' && window.POS_TRANSLATIONS !== null) {
            const keyMappings = {
                'lang_v1.pos_edit_product_price_help': 'pos_edit_product_price_help',
                'lang_v1.in_stock': 'in_stock',
                'lang_v1.item_out_of_stock': 'item_out_of_stock',
                'lang_v1.decimal_value_not_allowed': 'decimal_value_not_allowed',
                'validation.custom-messages.this_field_is_required': 'this_field_is_required',
                'validation.custom-messages.quantity_not_available': 'quantity_not_available',
                'lang_v1.quantity_error_msg_in_lot': 'quantity_error_msg_in_lot',
                'lang_v1.lot_n_expiry': 'lot_n_expiry',
                'product.exp_date': 'exp_date',
                'report.expired': 'expired',
                'lang_v1.sell_line_description_help': 'sell_line_description_help',
                'restaurant.select_service_staff': 'select_service_staff',
                'lang_v1.prev_unit_price': 'prev_unit_price',
                'lang_v1.prev_discount': 'prev_discount',
                'lang_v1.fixed': 'fixed',
                'lang_v1.percentage': 'percentage',
                'lang_v1.applied_discount_text': 'applied_discount_text',
                'messages.please_select': 'please_select',
                'lang_v1.quantity_in_second_unit': 'quantity_in_second_unit',
                'lang_v1.minimum_selling_price_error_msg': 'minimum_selling_price_error_msg',
                'sale.unit_price': 'unit_price',
                'sale.discount_type': 'discount_type',
                'sale.discount_amount': 'discount_amount',
                'sale.tax': 'tax',
                'lang_v1.warranty': 'warranty',
                'lang_v1.description': 'description',
                'messages.close': 'close',
                'lang_v1.no_products_found': 'no_products_found',
                'lang_v1.out_of_stock': 'out_of_stock'
            };
            
            const simpleKey = keyMappings[key];
            if (simpleKey && window.POS_TRANSLATIONS.hasOwnProperty(simpleKey)) {
                return window.POS_TRANSLATIONS[simpleKey];
            }
        }
        
        if (typeof window.__trans === 'function') {
            return window.__trans(key);
        }
        
        if (typeof window.LANG === 'object' && window.LANG !== null) {
            const keys = key.split('.');
            let value = window.LANG;
            
            for (let k of keys) {
                if (value && typeof value === 'object' && value.hasOwnProperty(k)) {
                    value = value[k];
                } else {
                    value = null;
                    break;
                }
            }
            
            if (value && typeof value === 'string') {
                return value;
            }
        }
        
        return key;
    },
    
    validateProductAddition: function(product, quantity = 1) {
        if (!product) {
            return { valid: false, message: 'Product not found' };
        }

        const isOverselling = POS_InstantCache.settings.allow_overselling == '1';
        const isDraft = $('input#status').length && $('input#status').val() == 'draft';
        const forSo = false; // Not handling sales orders in instant mode
        
        let qty_available;
        if (product.qty_available === null) {
            const formatted_qty = parseFloat(product.formatted_qty_available || 0);
            qty_available = formatted_qty > 0 ? Infinity : 0;
        } else {
            qty_available = parseFloat(product.qty_available || 0);
        }
        
        if (qty_available > 0 || isOverselling || forSo || isDraft) {
            return { valid: true };
        } else {
            return { 
                valid: false, 
                message: this.lang('lang_v1.item_out_of_stock')
            };
        }
    },

    generateProductRow: function(variationId, quantity = 1, rowCount = null, options = {}) {
        const product = POS_InstantCache.getProduct(variationId);
        if (!product) {
            return null;
        }
       
        // Get row count
        if (!rowCount) {
            rowCount = parseInt($('input#product_row_count').val()) + 1;
        }

        // Set default options
        const so_line = options.so_line || null;
        const discount = options.discount || null;
        const is_direct_sell = options.is_direct_sell || false;
        const is_sales_order = options.is_sales_order || false;
        const action = options.action || '';
        const purchase_line_id = options.purchase_line_id || null;
        const warranties = options.warranties || {};
        const waiters = options.waiters || {};
        const last_sell_line = options.last_sell_line || null;
        const combo_products = options.combo_products || [];
        const common_settings = POS_InstantCache.common_settings;
        
        let multiplier = 1;
        
        // Use server-processed image URL instead of generating it in JavaScript
        const image_url = product.image_url || this.asset('/img/default.png');
        const sub_units = POS_InstantCache.sub_units[product.unit_id] || {};
        Object.keys(sub_units).forEach(key => {
            const value = sub_units[key];
            if (product.sub_unit_id && product.sub_unit_id == key) {
                multiplier = value.multiplier;
            }
        });

        const product_name = product.product_name + (product.brand_id && POS_InstantCache.brands[product.brand_id] ? ' ' + POS_InstantCache.brands[product.brand_id] : '');

        let hide_tax = 'hide';
        if (POS_InstantCache.business.enable_inline_tax) {
            hide_tax = '';
        }
        
        let tax_id = product.tax_id || null;
        let item_tax = 0;
        let unit_price_inc_tax = parseFloat(product.sell_price_inc_tax || product.default_sell_price);
        
        // Check for group price and use it if available
        const currentPriceGroup = POS_InstantCache.getCurrentPriceGroup();
        if (currentPriceGroup) {
            const groupPrice = POS_InstantCache.getGroupPrice(product.variation_id, currentPriceGroup);
            if (groupPrice) {
                unit_price_inc_tax = parseFloat(groupPrice);
            }
        }
        
        // Apply customer group percentage discount if available
        if (window.pos_customer_group_discount && window.pos_customer_group_discount > 0) {
            const discountAmount = (unit_price_inc_tax * window.pos_customer_group_discount) / 100;
            unit_price_inc_tax = unit_price_inc_tax - discountAmount;
            console.log(`Applied customer group discount: ${window.pos_customer_group_discount}% to product ${product.product_name}, new price: ${unit_price_inc_tax}`);
        }

        if (tax_id && POS_InstantCache.taxes && POS_InstantCache.taxes.attributes && POS_InstantCache.taxes.attributes[tax_id]) {
            const tax_rate = parseFloat(POS_InstantCache.taxes.attributes[tax_id]['data-rate'] || 0);
            const default_price = parseFloat(product.default_sell_price || 0);
            item_tax = (default_price * tax_rate) / 100;
        }

        if (hide_tax == 'hide') {
            tax_id = null;
            unit_price_inc_tax = parseFloat(product.default_sell_price || 0);
        }

        if (so_line && action !== 'edit') {
            tax_id = so_line.tax_id;
            item_tax = so_line.item_tax;
            unit_price_inc_tax = so_line.unit_price_inc_tax;
        }

        let discount_type = product.line_discount_type || 'fixed';
        let discount_amount = product.line_discount_amount || 0;
        
        if (discount) {
            discount_type = discount.discount_type;
            discount_amount = discount.discount_amount;
        }

        if (so_line && action !== 'edit') {
            discount_type = so_line.line_discount_type;
            discount_amount = so_line.line_discount_amount;
        }

        let sell_line_note = '';
        if (product.sell_line_note) {
            sell_line_note = product.sell_line_note;
        }
        if (so_line) {
            sell_line_note = so_line.sell_line_note;
        }

        const warranty_id = (action == 'edit' && product.warranties && product.warranties.length > 0) ? product.warranties[0].id : (product.warranty_id || '');

        if (discount_type == 'fixed') {
            discount_amount = discount_amount * multiplier;
        }

        let max_quantity;
        if (product.qty_available === null) {
            // Check if formatted quantity indicates no stock
            const formatted_qty = parseFloat(product.formatted_qty_available || 0);
            max_quantity = formatted_qty > 0 ? 999999 : 0;
        } else {
            max_quantity = parseFloat(product.qty_available || 0);
        }
        let formatted_max_quantity = product.formatted_qty_available || this.format_quantity(max_quantity);

        if (action == 'edit') {
            if (so_line) {
                const qty_available = so_line.quantity - so_line.so_quantity_invoiced + (product.quantity_ordered || 1);
                max_quantity = qty_available;
                formatted_max_quantity = this.format_quantity(qty_available);
            }
        } else {
            if (so_line && so_line.qty_available <= max_quantity) {
                max_quantity = so_line.qty_available;
                formatted_max_quantity = so_line.formatted_qty_available;
            }
        }

        let max_qty_rule = max_quantity;
        
        // For validation message, use the same effective stock as the validation rule
        let effective_stock_for_msg = max_quantity;
        if (product.enable_stock == 1 && POS_InstantCache.settings.allow_overselling != '1' && !is_sales_order) {
            effective_stock_for_msg = this.getEffectiveStockForValidation(product);
        }
        
        let max_qty_msg = this.lang('validation.custom-messages.quantity_not_available').replace(':qty', this.format_quantity(effective_stock_for_msg)).replace(':unit', product.unit);

        const quantity_ordered = quantity || 1;

        // Decimal handling
        let allow_decimal = true;
        if (product.unit_allow_decimal != 1) {
            allow_decimal = false;
        }

        // Sub-unit calculations
        Object.keys(sub_units).forEach(key => {
            const value = sub_units[key];
            if (product.sub_unit_id && product.sub_unit_id == key) {
                max_qty_rule = max_qty_rule / multiplier;
                const unit_name = value.name;
                max_qty_msg = this.lang('validation.custom-messages.quantity_not_available').replace(':qty', max_qty_rule).replace(':unit', unit_name);

                if (product.lot_no_line_id) {
                    max_qty_msg = this.lang('lang_v1.quantity_error_msg_in_lot').replace(':qty', max_qty_rule).replace(':unit', unit_name);
                }

                if (value.allow_decimal) {
                    allow_decimal = true;
                }
            }
        });

        // Unit price calculation
        let pos_unit_price = product.unit_price_before_discount || product.default_sell_price;
        
        // Use group price for unit price if available
        if (currentPriceGroup) {
            const groupPrice = POS_InstantCache.getGroupPrice(product.variation_id, currentPriceGroup);
            if (groupPrice) {
                pos_unit_price = parseFloat(groupPrice);
            }
        }
        
        let final_pos_unit_price = pos_unit_price;
        if (so_line) {
            final_pos_unit_price = so_line.unit_price_before_discount;
        }

        // Edit permissions
        const edit_price = POS_InstantCache.permissions.edit_price;
        const edit_discount = POS_InstantCache.permissions.edit_discount;

        const html = `
            <tr class="product_row" data-row_index="${rowCount}"${so_line ? ` data-so_id="${so_line.transaction_id}"` : ''}>
                <input type="hidden" name="row_id" id="row_${rowCount}" value="${rowCount}">
                <input type="hidden" name="quantity_cd[${rowCount}]" id="quantity_cd" value="${this.format_quantity(quantity_ordered)}">
                
                <td><img src="${image_url}" alt="product-img" loading="lazy" style="height: auto;display: inline;margin-left: 3px; border: black;border-radius: 5px; margin-top: 5px; width: 50px;object-fit: cover;"></td>
                <td style="width: 25%">
                    ${so_line ? `<input type="hidden" name="products[${rowCount}][so_line_id]" value="${so_line.id}">` : ''}
                    
                    <input type="hidden" name="item_name[${rowCount}]" id="item_name" value="${product_name}">

                    ${(edit_price || edit_discount) && !is_direct_sell ? `
                    <div title="${this.lang('lang_v1.pos_edit_product_price_help')}">
                        <span class="text-link text-info cursor-pointer" data-toggle="modal" data-target="#row_edit_product_price_modal_${rowCount}">
                            ${product_name}
                            &nbsp;<i class="fa fa-info-circle"></i>
                        </span>
                    </div>` : product_name}
                    
                    <input type="hidden" class="enable_sr_no" value="${product.enable_sr_no || 0}">
                    <input type="hidden" class="product_type" name="products[${rowCount}][product_type]" value="${product.product_type || 'single'}">

                    <input type="hidden" name="discount_cd[${rowCount}]" id="discount_cd" value="${discount_amount}">
                    ${discount ? `<input type="hidden" name="products[${rowCount}][discount_id]" value="${discount.id}">` : ''}

                    ${!is_direct_sell ? `
                    <div class="modal fade row_edit_product_price_model" id="row_edit_product_price_modal_${rowCount}" tabindex="-1" role="dialog">
                        ${this.generateEditModal(rowCount, product, pos_unit_price, unit_price_inc_tax, discount_type, discount_amount, tax_id, item_tax, sell_line_note, warranty_id, warranties, discount)}
                    </div>` : ''}
                    
                    ${this.generateStockInfo(product)}
                    
                    <!-- Description modal end -->
                    <div class="modifiers_html">
                        ${this.generateModifiers(product, rowCount)}
                    </div>
                    <div class="selected_modifiers"></div>
                    
                    ${this.generateComboProducts(combo_products, rowCount)}
                    
                    ${this.generateLotNumbers(product, rowCount, max_qty_rule, max_qty_msg, purchase_line_id)}
                    
                    ${is_direct_sell ? `
                    <br>
                    <textarea class="form-control" name="products[${rowCount}][sell_line_note]" rows="2">${sell_line_note}</textarea>
                    <p class="help-block"><small>${this.lang('lang_v1.sell_line_description_help')}</small></p>` : ''}
                </td>

                <td class="unit-quantity-flex" style="max-width:17%">
                    ${product.transaction_sell_lines_id ? `<input type="hidden" name="products[${rowCount}][transaction_sell_lines_id]" class="form-control" value="${product.transaction_sell_lines_id}">` : ''}

                    <input type="hidden" name="products[${rowCount}][product_id]" class="form-control product_id" value="${product.product_id}">
                    <input type="hidden" value="${product.variation_id}" name="products[${rowCount}][variation_id]" class="row_variation_id">
                    <input type="hidden" value="${product.enable_stock}" name="products[${rowCount}][enable_stock]">

                    <div class="input-group input-number">
                        <span class="input-group-btn"><button type="button" class="btn btn-default btn-flat quantity-down"><i class="fa fa-minus text-danger"></i></button></span>
                        <input type="text" data-min="1"
                            class="form-control pos_quantity input_number mousetrap input_quantity width-100"
                            value="${this.format_quantity(quantity_ordered)}" 
                            name="products[${rowCount}][quantity]" 
                            data-allow-overselling="${POS_InstantCache.settings.allow_overselling == '1' ? 'true' : 'false'}"
                            ${allow_decimal ? 'data-decimal="1"' : 'data-decimal="0" data-rule-abs_digit="true" data-msg-abs_digit="' + this.lang('lang_v1.decimal_value_not_allowed') + '"'}
                            data-rule-required="true"
                            data-msg-required="${this.lang('validation.custom-messages.this_field_is_required')}"
                            ${product.enable_stock == 1 && POS_InstantCache.settings.allow_overselling != '1' && !is_sales_order ? `data-rule-max-value="${this.getEffectiveStockForValidation(product)}" data-qty_available="${product.original_qty_available || product.qty_available}" data-msg-max-value="${max_qty_msg}" data-msg_max_default="${max_qty_msg}"` : ''}>
                        <span class="input-group-btn"><button type="button" class="btn btn-default btn-flat quantity-up"><i class="fa fa-plus text-success"></i></button></span>
                    </div>

                    <input type="hidden" name="products[${rowCount}][product_unit_id]" value="${product.unit_id}">
                    ${this.generateUnitSelect(sub_units, product, rowCount)}

                    ${product.second_unit ? `
                    <br>
                    <span style="white-space: nowrap;">
                        ${this.lang('lang_v1.quantity_in_second_unit').replace('{unit}', product.second_unit)}*:</span><br>
                    <input type="text"
                        name="products[${rowCount}][secondary_unit_quantity]"
                        value="${this.format_quantity(product.secondary_unit_quantity || 0)}"
                        class="form-control input-sm input_number"
                        required>` : ''}

                    <input type="hidden" class="base_unit_multiplier" name="products[${rowCount}][base_unit_multiplier]" value="${multiplier}">
                    <input type="hidden" class="hidden_base_unit_sell_price" value="${product.default_sell_price / multiplier}">

                    ${this.generateComboHiddenFields(product, rowCount, action)}
                </td>
                
                ${this.generateDirectSellColumns(is_direct_sell, waiters, rowCount, product, final_pos_unit_price, last_sell_line, edit_price, edit_discount, discount_amount, discount_type, discount)}
                
                ${this.generateNonDirectSellColumns(is_direct_sell, waiters, rowCount, product, hide_tax, item_tax, unit_price_inc_tax, edit_price, common_settings, warranties, warranty_id)}

                <td class="text-center">
                    <input type="${POS_InstantCache.settings.is_pos_subtotal_editable == '1' ? 'text' : 'hidden'}" 
                           style="height: 30px; line-height: 30px;" 
                           class="form-control input-sm pos_line_total${POS_InstantCache.settings.is_pos_subtotal_editable == '1' ? ' input_number' : ''}" 
                           value="${this.num_format(quantity_ordered * unit_price_inc_tax)}">
                    <span class="display_currency pos_line_total_text${POS_InstantCache.settings.is_pos_subtotal_editable == '1' ? ' hide' : ''}" 
                          data-currency_symbol="true">${this.format_currency(quantity_ordered * unit_price_inc_tax)}</span>
                </td>
                <td class="text-center v-center">
                    <i class="fa fa-times text-danger pos_remove_row cursor-pointer" aria-hidden="true"></i>
                </td>
            </tr>`;

        return html;
    },

    // Get effective stock for initial validation (original product stock, not lot-based)
    getEffectiveStockForValidation: function(product) {
        // Check if product actually has lots available (with real lot numbers, not null)  
        const lot_numbers = POS_InstantCache.getLotNumbers(product.variation_id);
        const actual_lots = lot_numbers ? lot_numbers.filter(lot => lot.lot_number && lot.lot_number !== null && lot.lot_number.trim() !== '') : [];
        const has_lots = product.has_lots || actual_lots.length > 0;
        
        if ((POS_InstantCache.business.enable_lot_number || POS_InstantCache.business.enable_product_expiry) && has_lots) {
            if (product.has_mixed_stock) {
                // Mixed stock: use original_qty_available (non-lot stock) for initial selling
                const effective_stock = parseFloat(product.original_qty_available !== undefined ? product.original_qty_available : product.qty_available || 0);
                console.log(`Initial validation stock (mixed stock) - Product ${product.variation_id}: has_mixed_stock=true, using ${effective_stock}`);
                return effective_stock;
            } else {
                // Only lot stock: force lot selection
                const effective_stock = parseFloat(product.original_qty_available !== undefined ? product.original_qty_available : 0);
                console.log(`Initial validation stock (lots only) - Product ${product.variation_id}: has_lots=${has_lots}, using ${effective_stock}`);
                return effective_stock;
            }
        } else {
            // For products without lots, use regular stock
            const effective_stock = parseFloat(product.qty_available || 0);
            console.log(`Initial validation stock (no lots) - Product ${product.variation_id}: has_lots=${has_lots}, using ${effective_stock}`);
            return effective_stock;
        }
    },

    // Generate stock information
    generateStockInfo: function(product) {
        if (product.enable_stock == 1) {
            // Check if product actually has lots available (with real lot numbers, not null)
            const lot_numbers = POS_InstantCache.getLotNumbers(product.variation_id);
            const actual_lots = lot_numbers ? lot_numbers.filter(lot => lot.lot_number && lot.lot_number !== null && lot.lot_number.trim() !== '') : [];
            const has_lots = product.has_lots || actual_lots.length > 0;
            
            // For products with lots, show appropriate behavior
            if ((POS_InstantCache.business.enable_lot_number || POS_InstantCache.business.enable_product_expiry) && has_lots) {
                if (product.has_mixed_stock) {
                    // Mixed stock: show non-lot stock with lot option
                    qty_available = parseFloat(product.original_qty_available !== undefined ? product.original_qty_available : product.qty_available || 0);
                    console.log(`Initial stock display (mixed stock) - Product ${product.variation_id}: has_mixed_stock=true, non_lot_qty=${product.original_qty_available}, total_qty=${product.qty_available}, using=${qty_available}`);
                    
                    let stockText = `${this.format_quantity(qty_available)} ${product.unit}`;
                    
                    if (qty_available > 0) {
                        stockText += ` ${this.lang('lang_v1.in_stock')}`;
                    } else {
                        stockText += ` ${this.lang('lang_v1.item_out_of_stock')}`;
                    }
                    
                    stockText += ` <span class="text-info">(or select lot)</span>`;
                    
                    return `<small class="text-muted p-1 stock-info" data-variation-id="${product.variation_id}">${stockText}</small>`;
                } else {
                    // Only lot stock: force lot-based selling
                    qty_available = parseFloat(product.original_qty_available !== undefined ? product.original_qty_available : 0);
                    console.log(`Initial stock display (lots only) - Product ${product.variation_id}: has_lots=${has_lots}, original=${product.original_qty_available}, qty=${product.qty_available}, using=${qty_available}`);
                    
                    let stockText = `${this.format_quantity(qty_available)} ${product.unit}`;
                    
                    if (qty_available > 0) {
                        stockText += ` ${this.lang('lang_v1.in_stock')}`;
                    } else {
                        stockText += ` ${this.lang('lang_v1.item_out_of_stock')}`;
                    }
                    
                    stockText += ` <span class="text-info">Please select lot</span>`;
                    
                    return `<small class="text-muted p-1 stock-info" data-variation-id="${product.variation_id}">${stockText}</small>`;
                }
            } else {
                // Regular stock display for non-lot products
                if (product.qty_available === null) {
                    const formatted_qty = parseFloat(product.formatted_qty_available || 0);
                    qty_available = formatted_qty;
                } else {
                    qty_available = parseFloat(product.qty_available || 0);
                }
                
                let stockText = `${product.formatted_qty_available || this.format_quantity(qty_available)} ${product.unit}`;
                
                if (qty_available > 0) {
                    stockText += ` ${this.lang('lang_v1.in_stock')}`;
                } else {
                    stockText += ` ${this.lang('lang_v1.item_out_of_stock')}`;
                }
                
                return `<small class="text-muted p-1">${stockText}</small>`;
            }
        } else if (product.manage_stock == 0) {
            return '<small class="text-muted p-1">~</small>';
        }
        return '';
    },

    // Update stock display dynamically when lot is selected
    updateStockDisplay: function(row, selected_lot_id, qty_available, selected_text, product_data, fallback_variation_id) {
        let stock_info = row.find('.stock-info');
        console.log('updateStockDisplay called:', {
            stock_info_found: stock_info.length > 0,
            selected_lot_id: selected_lot_id,
            qty_available: qty_available,
            product_data: product_data
        });
        
        if (stock_info.length === 0) {
            console.warn('Stock info element not found. Looking for any stock display...');
            // Try to find any stock display element in the row
            const alt_stock = row.find('small.text-muted.p-1');
            if (alt_stock.length > 0) {
                console.log('Found alternative stock element, adding stock-info class');
                alt_stock.addClass('stock-info');
                stock_info = alt_stock.first();
            } else {
                console.error('No stock display element found in row');
                return;
            }
        }
        
        if (!product_data) {
            console.error('Product data not provided to updateStockDisplay');
            return;
        }
        
        let stockText;
        
        if (selected_lot_id && qty_available > 0) {
            // Lot selected with stock - show lot quantity and details
            stockText = `${this.format_quantity(qty_available)} ${product_data.unit} ${this.lang('lang_v1.in_stock')}`;
            
            // Extract lot number from selected text (format: "550 - EXP Date: 2025-08-27")
            const lot_match = selected_text.match(/^(\w+)/);
            const lot_number = lot_match ? lot_match[1] : 'Selected';
            
            stockText += ` <span class="text-info">(Lot ${lot_number}: ${this.format_quantity(qty_available)} total)</span>`;
            console.log('Showing lot stock:', stockText);
        } else if (selected_lot_id && qty_available <= 0) {
            // Lot selected but no stock
            stockText = `0.000 ${product_data.unit} ${this.lang('lang_v1.item_out_of_stock')} <span class="text-warning">(Selected lot out of stock)</span>`;
            console.log('Showing lot out of stock:', stockText);
        } else {
            // No lot selected - determine what to show
            const lot_numbers = POS_InstantCache.getLotNumbers(product_data.variation_id);
            const actual_lots = lot_numbers ? lot_numbers.filter(lot => lot.lot_number && lot.lot_number !== null && lot.lot_number.trim() !== '') : [];
            
            // Use proper fallback for original_qty_available (0 is a valid value)
            const original_qty = parseFloat(product_data.original_qty_available !== undefined ? product_data.original_qty_available : product_data.qty_available || 0);
            
            console.log('No lot selected - product_data.original_qty_available:', product_data.original_qty_available, 'product_data.qty_available:', product_data.qty_available, 'using original_qty:', original_qty);
            
            if (actual_lots.length > 0) {
                // Product has actual lots
                if (product_data.has_mixed_stock) {
                    // Mixed stock: show normal stock with lot option
                    const display_qty = parseFloat(product_data.qty_available || 0);
                    stockText = `${this.format_quantity(display_qty)} ${product_data.unit}`;
                    
                    if (display_qty > 0) {
                        stockText += ` ${this.lang('lang_v1.in_stock')}`;
                    } else {
                        stockText += ` ${this.lang('lang_v1.item_out_of_stock')}`;
                    }
                    
                    stockText += ` <span class="text-info">(or select lot)</span>`;
                } else {
                    // Lot-only products: show original stock with "Please select lot"
                    stockText = `${this.format_quantity(original_qty)} ${product_data.unit}`;
                    
                    if (original_qty > 0) {
                        stockText += ` ${this.lang('lang_v1.in_stock')}`;
                    } else {
                        stockText += ` ${this.lang('lang_v1.item_out_of_stock')}`;
                    }
                    
                    stockText += ` <span class="text-info">Please select lot</span>`;
                }
            } else {
                // Product has no actual lots - show normal stock
                stockText = `${this.format_quantity(original_qty)} ${product_data.unit}`;
                
                if (original_qty > 0) {
                    stockText += ` ${this.lang('lang_v1.in_stock')}`;
                } else {
                    stockText += ` ${this.lang('lang_v1.item_out_of_stock')}`;
                }
            }
            console.log('Showing original stock:', stockText);
        }
        
        stock_info.html(stockText);
        console.log('Stock display updated successfully');
    },

    // Generate modifiers
    generateModifiers: function(product, rowCount) {
        if (!POS_InstantCache.enabled_modules.includes('modifiers') || !product.product_ms || product.product_ms.length === 0) {
            return '';
        }

        const modal_id = `modifier_${rowCount}_${product.variation_id || ''}_${Date.now()}`;
        
        let html = `
            <div>
                <span class="selected_modifiers" id="selected_modifiers_${modal_id}">
                    <i class="fa fa-external-link-alt cursor-pointer text-primary select-modifiers-btn" 
                       title="Modifiers for product" data-toggle="modal" data-target="#${modal_id}"></i>
                </span>&nbsp;  
            </div>
            
            <div class="modal fade modifier_modal" id="${modal_id}" tabindex="-1" role="dialog">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                            <h4 class="modal-title">Modifiers for product: <span class="text-success">${product.product_name}</span></h4>
                        </div>
                        
                        <div class="modal-body">
                            <div class="panel-group" id="accordion${modal_id}" role="tablist" aria-multiselectable="true">
        `;

        // Generate modifier sets
        product.product_ms.forEach((modifier_set, setIndex) => {
            const collapse_id = `collapse${modifier_set.id}_${modal_id}`;
            const isFirstSet = setIndex === 0;
            
            html += `
                <div class="panel panel-default">
                    <div class="panel-heading" role="tab">
                        <h4 class="panel-title">
                            <a role="button" data-toggle="collapse" data-parent="#accordion${modal_id}" 
                               href="#${collapse_id}" aria-expanded="${isFirstSet}" aria-controls="${collapse_id}">
                                ${modifier_set.name}
                            </a>
                        </h4>
                    </div>
                    <input type="hidden" class="modifiers_exist" value="true">
                    <input type="hidden" class="index" value="${rowCount}">
                    
                    <div id="${collapse_id}" class="panel-collapse collapse ${isFirstSet ? 'in' : ''}" 
                         role="tabpanel">
                        <div class="panel-body">
                            <div class="btn-group" data-toggle="buttons">
            `;
            
            // Generate variations (modifiers) for this set
            if (modifier_set.variations && modifier_set.variations.length > 0) {
                modifier_set.variations.forEach(modifier => {
                    html += `
                        <label class="btn btn-primary">
                            <input type="checkbox" autocomplete="off" value="${modifier.id}"> 
                            ${modifier.name}
                        </label>
                    `;
                });
            }
            
            html += `
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });

        html += `
                            </div>
                        </div>
                        
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary add_modifier" data-dismiss="modal">
                                Add
                            </button>
                            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        return html;
    },

    // Initialize modifier event handlers
    initializeModifierHandlers: function() {
        // Handle modifier selection
        $(document).off('click.modifiers', '.add_modifier').on('click.modifiers', '.add_modifier', function() {
            const modal = $(this).closest('.modifier_modal');
            const modal_id = modal.attr('id');
            const selectedModifiers = [];
            const selectedModifierNames = [];
            
            // Get all selected modifiers
            modal.find('input[type="checkbox"]:checked').each(function() {
                const modifierId = $(this).val();
                const modifierName = $(this).closest('label').text().trim();
                selectedModifiers.push(modifierId);
                selectedModifierNames.push(modifierName);
            });
            
            // Update selected modifiers display
            const selectedSpan = $(`#selected_modifiers_${modal_id}`);
            if (selectedModifierNames.length > 0) {
                selectedSpan.html(`
                    <span class="label label-info">${selectedModifierNames.join(', ')}</span>
                    <i class="fa fa-external-link-alt cursor-pointer text-primary select-modifiers-btn" 
                       title="Modifiers for product" data-toggle="modal" data-target="#${modal_id}"></i>
                `);
            } else {
                selectedSpan.html(`
                    <i class="fa fa-external-link-alt cursor-pointer text-primary select-modifiers-btn" 
                       title="Modifiers for product" data-toggle="modal" data-target="#${modal_id}"></i>
                `);
            }
            
            // Store selected modifier IDs in hidden field (if needed for form submission)
            const row = modal.closest('tr');
            if (row.length === 0) {
                // Handle case where modal is not inside table row yet
                return;
            }
            
            // Create or update hidden field for modifier IDs
            let modifierInput = row.find('input.selected_modifier_ids');
            if (modifierInput.length === 0) {
                row.append(`<input type="hidden" class="selected_modifier_ids" name="products[${row.index()}][modifier_ids]" value="">`);
                modifierInput = row.find('input.selected_modifier_ids');
            }
            modifierInput.val(selectedModifiers.join(','));
            
            console.log('Modifiers selected:', selectedModifiers);
        });
    },

    // Generate combo products
    generateComboProducts: function(combo_products, rowCount) {
        if (!combo_products || combo_products.length === 0) return '';
        
        let html = '<div class="combo_modifiers">';
        combo_products.forEach((combo_product, index) => {
            for (let i = 0; i < combo_product.quantity; i++) {
                const instance_index = `${rowCount}_${index}_${i}`;
                const modal_id = `modifier_${instance_index}_${combo_product.variation_id || ''}_${Date.now()}`;
                const qty_total = 0;

                html += `
                    <div>${combo_product.product_name}</div>
                    <input type="hidden" name="products[${rowCount}][combo][${index}][product_id]" value="${combo_product.product_id}">
                    <input type="hidden" name="products[${rowCount}][combo][${index}][variation_id]" value="${combo_product.variation_id}">
                    <input type="hidden" class="combo_product_qty" name="products[${rowCount}][combo][${index}][quantity]" data-unit_quantity="${combo_product.quantity}" value="${qty_total}">
                    <input type="hidden" name="products[${rowCount}][combo][${index}][modifier_ids]" class="combo_modifier_ids_${rowCount}_${index}_${i}" value="">
                    <input type="hidden" name="products[${rowCount}][combo][${index}][single_modifier_ids]" class="single_combo_modifier_ids_${rowCount}_${index}_${i}" value="">
                    <input type="hidden" class="instance_index" value="${instance_index}">
                `;
            }
        });
        html += '</div>';
        return html;
    },

    // Generate lot numbers using cached data
    generateLotNumbers: function(product, rowCount, max_qty_rule, max_qty_msg, purchase_line_id) {
        if (POS_InstantCache.business.enable_lot_number || POS_InstantCache.business.enable_product_expiry) {
            // Get lot numbers from cache
            const lot_numbers = POS_InstantCache.getLotNumbers(product.variation_id);
            const actual_lots = lot_numbers ? lot_numbers.filter(lot => lot.lot_number && lot.lot_number !== null && lot.lot_number.trim() !== '') : [];
            const has_lots = product.has_lots || actual_lots.length > 0;
            
            // Only show lot dropdown for products that actually have lots
            if (has_lots && lot_numbers && lot_numbers.length > 0 && !product.is_sales_order) {
                let html = `<select class="form-control lot_number input-sm" name="products[${rowCount}][lot_no_line_id]"${product.transaction_sell_lines_id ? ' disabled' : ''}>`;
                html += `<option value="">${this.lang('lang_v1.lot_n_expiry')}</option>`;
                
                lot_numbers.forEach(lot_number => {
                    let selected = '';
                    if (lot_number.purchase_line_id == (product.lot_no_line_id || purchase_line_id)) {
                        selected = 'selected';
                    }
                    
                    let expiry_text = '';
                    if (POS_InstantCache.business.enable_product_expiry && lot_number.exp_date) {
                        const exp_date = new Date(lot_number.exp_date);
                        const current_date = new Date();
                        // Add debugging for expiry date logic
                        console.log('Checking expiry for lot', lot_number.lot_number, '- Exp date:', lot_number.exp_date, 'Current date:', current_date.toISOString().split('T')[0], 'Expired:', current_date > exp_date);
                        if (current_date > exp_date) {
                            expiry_text = ` (${this.lang('report.expired')})`;
                        }
                    }
                    
                    html += `<option value="${lot_number.purchase_line_id}" data-qty_available="${lot_number.qty_available}" data-exp_date="${lot_number.exp_date || ''}" data-msg-max="${this.lang('lang_v1.quantity_error_msg_in_lot').replace(':qty', lot_number.qty_formated).replace(':unit', product.unit)}" ${selected}>`;
                    
                    if (lot_number.lot_number && POS_InstantCache.business.enable_lot_number) {
                        html += lot_number.lot_number;
                    }
                    if (POS_InstantCache.business.enable_lot_number && POS_InstantCache.business.enable_product_expiry) {
                        html += ' - ';
                    }
                    if (POS_InstantCache.business.enable_product_expiry && lot_number.exp_date) {
                        html += `${this.lang('product.exp_date')}: ${lot_number.exp_date}`;
                    }
                    html += expiry_text + '</option>';
                });
                
                html += '</select>';
                return html;
            }
        }
        return '';
    },

    // Generate unit select
    generateUnitSelect: function(sub_units, product, rowCount) {
        if (Object.keys(sub_units).length > 0) {
            let html = `<select name="products[${rowCount}][sub_unit_id]" class="form-control input-sm sub_unit">`;
            Object.keys(sub_units).forEach(key => {
                const value = sub_units[key];
                const selected = product.sub_unit_id == key ? 'selected' : '';
                html += `<option value="${key}" data-multiplier="${value.multiplier}" data-unit_name="${value.name}" data-allow_decimal="${value.allow_decimal}" ${selected}>${value.name}</option>`;
            });
            html += '</select>';
            return html;
        } else {
            return product.unit || 'Pc(s)';
        }
    },

    // Generate combo hidden fields
    generateComboHiddenFields: function(product, rowCount, action) {
        if (product.product_type == 'combo' && product.combo_products) {
            let html = '';
            product.combo_products.forEach((combo_product, k) => {
                let qty_total;
                if (action == 'edit') {
                    combo_product.qty_required = combo_product.quantity / product.quantity_ordered;
                    qty_total = combo_product.quantity;
                } else {
                    qty_total = combo_product.qty_required;
                }

                html += `
                    <input type="hidden" name="products[${rowCount}][combo][${k}][product_id]" value="${combo_product.product_id}">
                    <input type="hidden" name="products[${rowCount}][combo][${k}][variation_id]" value="${combo_product.variation_id}">
                    <input type="hidden" class="combo_product_qty" name="products[${rowCount}][combo][${k}][quantity]" data-unit_quantity="${combo_product.qty_required}" value="${qty_total}">
                `;

                if (action == 'edit') {
                    html += `<input type="hidden" name="products[${rowCount}][combo][${k}][transaction_sell_lines_id]" value="${combo_product.id}">`;
                }
            });
            return html;
        }
        return '';
    },

    // Generate direct sell columns
    generateDirectSellColumns: function(is_direct_sell, waiters, rowCount, product, pos_unit_price, last_sell_line, edit_price, edit_discount, discount_amount, discount_type, discount) {
        if (!is_direct_sell) return '';

        let html = '';
        
        if (POS_InstantCache.settings.inline_service_staff == '1') {
            html += `
                <td>
                    <div class="form-group">
                        <div class="input-group">
                            <select name="products[${rowCount}][res_service_staff_id]" class="form-control input-sm select2 order_line_service_staff" ${POS_InstantCache.settings.is_service_staff_required == '1' ? 'required' : ''}>
                                <option value="">${this.lang('restaurant.select_service_staff')}</option>
                                ${Object.keys(waiters).map(id => `<option value="${id}" ${product.res_service_staff_id == id ? 'selected' : ''}>${waiters[id]}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                </td>`;
        }

        html += `
            <td class="${edit_price ? '' : 'hide'}">
                <input type="text" name="products[${rowCount}][unit_price]" class="form-control input-sm pos_unit_price input_number mousetrap" value="${this.num_format(pos_unit_price)}" ${POS_InstantCache.settings.enable_msp == '1' ? `data-rule-min-value="${pos_unit_price}" data-msg-min-value="${this.lang('lang_v1.minimum_selling_price_error_msg').replace('{price}', this.num_format(pos_unit_price))}"` : ''}>
                ${last_sell_line ? `
                <br>
                <small class="text-muted">${this.lang('lang_v1.prev_unit_price')}: ${this.format_currency(last_sell_line.unit_price_before_discount)}</small>
                <br>
                <small class="text-muted">
                    ${this.lang('lang_v1.prev_discount')}:
                    ${last_sell_line.line_discount_type == 'percentage' ? this.num_format(last_sell_line.line_discount_amount) + '%' : this.format_currency(last_sell_line.line_discount_amount)}
                </small>` : ''}
            </td>

            <td class="${edit_discount ? '' : 'hide'}">
                <input type="text" name="products[${rowCount}][line_discount_amount]" class="form-control input-sm input_number row_discount_amount" value="${this.num_format(discount_amount)}"><br>
                <select name="products[${rowCount}][line_discount_type]" class="form-control input-sm row_discount_type">
                    <option value="fixed" ${discount_type == 'fixed' ? 'selected' : ''}>${this.lang('lang_v1.fixed')}</option>
                    <option value="percentage" ${discount_type == 'percentage' ? 'selected' : ''}>${this.lang('lang_v1.percentage')}</option>
                </select>
                ${discount ? `<p class="help-block">${this.lang('lang_v1.applied_discount_text').replace('{discount_name}', discount.name).replace('{starts_at}', discount.formated_starts_at).replace('{ends_at}', discount.formated_ends_at)}</p>` : ''}
            </td>

            <td class="text-center ${POS_InstantCache.business.enable_inline_tax ? '' : 'hide'}">
                <input type="hidden" name="products[${rowCount}][item_tax]" class="item_tax" value="${this.num_format(product.item_tax || 0)}">
                <select name="products[${rowCount}][tax_id]" class="form-control input-sm tax_id width-100">
                    <option value="">Select</option>
                    ${this.generateTaxOptions(product.tax_id)}
                </select>
            </td>`;

        return html;
    },

    // Generate non-direct sell columns
    generateNonDirectSellColumns: function(is_direct_sell, waiters, rowCount, product, hide_tax, item_tax, unit_price_inc_tax, edit_price, common_settings, warranties, warranty_id) {
        if (is_direct_sell) return '';

        let html = '';
        
        if (POS_InstantCache.settings.inline_service_staff == '1') {
            html += `
                <td>
                    <div class="form-group">
                        <div class="input-group">
                            <select name="products[${rowCount}][res_service_staff_id]" class="form-control input-sm select2 order_line_service_staff" ${POS_InstantCache.settings.is_service_staff_required == '1' ? 'required' : ''}>
                                <option value="">${this.lang('restaurant.select_service_staff')}</option>
                                ${Object.keys(waiters).map(id => `<option value="${id}" ${product.res_service_staff_id == id ? 'selected' : ''}>${waiters[id]}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                </td>`;
        }

        html += `
            <td class="${hide_tax}">
                <input type="hidden" name="item_price[${rowCount}]" id="item_price" value="${this.num_format(unit_price_inc_tax)}">
                <input type="text" name="products[${rowCount}][unit_price_inc_tax]" style="height: 30px; line-height: 30px;" class="form-control input-sm pos_unit_price_inc_tax input_number" value="${this.num_format(unit_price_inc_tax)}" ${!edit_price ? 'readonly' : ''} ${POS_InstantCache.settings.enable_msp == '1' ? `data-rule-min-value="${unit_price_inc_tax}" data-msg-min-value="${this.lang('lang_v1.minimum_selling_price_error_msg').replace('{price}', this.num_format(unit_price_inc_tax))}"` : ''}>
            </td>`;

        if (common_settings.enable_product_warranty == '1' && is_direct_sell) {
            html += `
                <td>
                    <select name="products[${rowCount}][warranty_id]" class="form-control input-sm">
                        <option value="">${this.lang('messages.please_select')}</option>
                        ${Object.keys(warranties).map(id => `<option value="${id}" ${warranty_id == id ? 'selected' : ''}>${warranties[id]}</option>`).join('')}
                    </select>
                </td>`;
        }

        return html;
    },

    // Generate tax options
    generateTaxOptions: function(selected_tax_id) {
        let options = '';
        if (POS_InstantCache.taxes && POS_InstantCache.taxes.tax_rates) {
            Object.keys(POS_InstantCache.taxes.tax_rates).forEach(key => {
                const taxName = POS_InstantCache.taxes.tax_rates[key];
                const selected = selected_tax_id == key ? 'selected' : '';
                const attributes = POS_InstantCache.taxes.attributes && POS_InstantCache.taxes.attributes[key] ? 
                    Object.entries(POS_InstantCache.taxes.attributes[key]).map(([attr, val]) => `${attr}="${val}"`).join(' ') : '';
                options += `<option value="${key}" ${selected} ${attributes}>${taxName}</option>`;
            });
        }
        return options;
    },

    // Generate edit modal (simplified version - would need full implementation)
    generateEditModal: function(rowCount, product, pos_unit_price, unit_price_inc_tax, discount_type, discount_amount, tax_id, item_tax, sell_line_note, warranty_id, warranties, discount) {
        const brandName = product.brand_id ? (POS_InstantCache.brands[product.brand_id] || '') : '';
        const productDisplayName = product.product_name + (brandName ? ' ' + brandName : '');
        
        return `
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title">${productDisplayName} - ${product.sub_sku}</h4>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="form-group col-xs-12 ${POS_InstantCache.permissions.edit_price ? '' : 'hide'}">
                                <label>${this.lang('sale.unit_price')}</label>
                                <input type="text" name="products[${rowCount}][unit_price]" class="form-control pos_unit_price input_number mousetrap" value="${this.num_format(pos_unit_price)}" ${POS_InstantCache.settings.enable_msp == '1' ? `data-rule-min-value="${pos_unit_price}" data-msg-min-value="${this.lang('lang_v1.minimum_selling_price_error_msg').replace('{price}', this.num_format(pos_unit_price))}"` : ''}>
                            </div>
                            ${!POS_InstantCache.permissions.edit_price ? `
                            <div class="form-group col-xs-12">
                                <strong>${this.lang('sale.unit_price')}:</strong> ${this.format_currency(pos_unit_price)}
                            </div>` : ''}
                            <div class="form-group col-xs-12 col-sm-6 ${POS_InstantCache.permissions.edit_discount ? '' : 'hide'}">
                                <label>${this.lang('sale.discount_type')}</label>
                                <select name="products[${rowCount}][line_discount_type]" class="form-control row_discount_type">
                                    <option value="fixed" ${discount_type == 'fixed' ? 'selected' : ''}>${this.lang('lang_v1.fixed')}</option>
                                    <option value="percentage" ${discount_type == 'percentage' ? 'selected' : ''}>${this.lang('lang_v1.percentage')}</option>
                                </select>
                            </div>
                            <div class="form-group col-xs-12 col-sm-6 ${POS_InstantCache.permissions.edit_discount ? '' : 'hide'}">
                                <label>${this.lang('sale.discount_amount')}</label>
                                <input type="text" name="products[${rowCount}][line_discount_amount]" class="form-control input_number row_discount_amount" value="${this.num_format(discount_amount)}">
                            </div>
                            ${discount ? `
                            <div class="form-group col-xs-12">
                                <p class="help-block">${this.lang('lang_v1.applied_discount_text').replace('{discount_name}', discount.name).replace('{starts_at}', discount.formated_starts_at).replace('{ends_at}', discount.formated_ends_at)}</p>
                            </div>` : ''}
                            <div class="form-group col-xs-12 ${POS_InstantCache.business.enable_inline_tax ? '' : 'hide'}">
                                <label>${this.lang('sale.tax')}</label>
                                <input type="hidden" name="products[${rowCount}][item_tax]" class="item_tax" value="${this.num_format(item_tax)}">
                                <select name="products[${rowCount}][tax_id]" class="form-control tax_id">
                                    <option value="">Select</option>
                                    ${this.generateTaxOptions(tax_id)}
                                </select>
                            </div>
                            ${Object.keys(warranties || {}).length > 0 ? `
                            <div class="form-group col-xs-12">
                                <label>${this.lang('lang_v1.warranty')}</label>
                                <select name="products[${rowCount}][warranty_id]" class="form-control">
                                    <option value="">${this.lang('messages.please_select')}</option>
                                    ${Object.keys(warranties).map(id => `<option value="${id}" ${warranty_id == id ? 'selected' : ''}>${warranties[id]}</option>`).join('')}
                                </select>
                            </div>` : ''}
                            <div class="form-group col-xs-12">
                                <label>${this.lang('lang_v1.description')}</label>
                                <textarea class="form-control" name="products[${rowCount}][sell_line_note]" rows="3">${sell_line_note}</textarea>
                                <p class="help-block">${this.lang('lang_v1.sell_line_description_help')}</p>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">${this.lang('messages.close')}</button>
                    </div>
                </div>
            </div>`;
    }
};

// Initialize customer group discount
window.pos_customer_group_discount = 0;
window.pos_selected_customer_data = null;

$(document).ready(function() {
    setTimeout(function() {
        if (typeof window.pos_product_row === 'function') {
            window.original_pos_product_row = window.pos_product_row;
        }

        window.pos_product_row = function(variation_id = null, purchase_line_id = null, weighing_scale_barcode = null, quantity = 1) {
           
            if (window.pos_processing && window.pos_processing === variation_id) {
                return;
            }
            
            window.pos_processing = variation_id;
            setTimeout(() => {
                window.pos_processing = null;
            }, 500);

            if (!POS_InstantCache.initialized || !POS_InstantCache.getProduct(variation_id)) {
                window.pos_processing = null;
                if (window.original_pos_product_row) {
                    return window.original_pos_product_row(variation_id, purchase_line_id, weighing_scale_barcode, quantity);
                }
                return;
            }

            var item_addtn_method = 0;
            var add_via_instant = true;

            if (variation_id != null && $('#item_addition_method').length) {
                item_addtn_method = $('#item_addition_method').val();
            }

            if (item_addtn_method == 0) {
                add_via_instant = true;
            } else {
                var is_added = false;
                $('#pos_table tbody').find('tr').each(function() {
                    var row_v_id = $(this).find('.row_variation_id').val();
                    var enable_sr_no = $(this).find('.enable_sr_no').val();
                    var modifiers_exist = $(this).find('input.modifiers_exist').length > 0;

                    if (row_v_id == variation_id && enable_sr_no !== '1' && !modifiers_exist && !is_added) {
                        add_via_instant = false;
                        is_added = true;
                        var qty_element = $(this).find('.pos_quantity');
                        var qty = parseFloat(qty_element.val()) || 0;
                        var new_qty = qty + parseFloat(quantity);
                        qty_element.val(new_qty);
                        qty_element.trigger('change');
                        
                        $('input#search_product').focus().select();
                        window.pos_processing = null;
                    }
                });
            }

            if (add_via_instant) {
                // First check if product exists in cache
                const product = POS_InstantCache.getProduct(variation_id);
                if (!product) {
                    if (window.original_pos_product_row) {
                        window.original_pos_product_row(variation_id, purchase_line_id, weighing_scale_barcode, quantity);
                    }
                    window.pos_processing = null;
                    return;
                }

                const validation = POS_RowGenerator.validateProductAddition(product, quantity);
                if (!validation.valid) {
                    toastr.error(validation.message);
                    $('input#search_product').focus().select();
                    window.pos_processing = null;
                    return;
                }

                try {
                    var product_row_count = parseInt($('input#product_row_count').val()) || 0;
                    var new_row_count = product_row_count + 1;
                    
                    var html = POS_RowGenerator.generateProductRow(variation_id, quantity, new_row_count, {
                        purchase_line_id: purchase_line_id
                    });
                    
                    if (html) {
                        $('table#pos_table tbody').append(html);
                        $('input#product_row_count').val(new_row_count);
                        
                        var new_row = $('table#pos_table tbody tr:last');
                        new_row.find('.pos_quantity').trigger('change');
                        
                        // Initialize modifier handlers for the new row
                        if (typeof POS_RowGenerator !== 'undefined' && POS_RowGenerator.initializeModifierHandlers) {
                            POS_RowGenerator.initializeModifierHandlers();
                        }
                        
                        $('input#search_product').focus().select();
                        
                        //toastr.success('Product added successfully');
                        
                    } else {
                        throw new Error('Failed to generate product row HTML');
                    }
                    
                } catch (error) {
                    if (window.original_pos_product_row) {
                        window.original_pos_product_row(variation_id, purchase_line_id, weighing_scale_barcode, quantity);
                    }
                }
            }
            
            window.pos_processing = null;
        };


        // Only if instant search is enabled
        if (window.POS_APP_SETTINGS && window.POS_APP_SETTINGS.enable_instant_search) {
            if ($('#search_product').length && $('#search_product').hasClass('ui-autocomplete-input')) {
                $('#search_product').autocomplete('destroy');
            }

            if ($('#search_product').length) {
            $('#search_product').autocomplete({
                delay: 100,
                source: function(request, response) {
                    if (!POS_InstantCache.initialized) {
                        response([]);
                        return;
                    }

                    // Get search fields
                    var search_fields = [];
                    $('.search_fields:checked').each(function(i){
                        search_fields[i] = $(this).val();
                    });
                    
                    if (search_fields.length === 0) {
                        search_fields = ['name', 'sku']; // Default search fields
                    }

                    // Search in cache instead of AJAX
                    const results = POS_InstantCache.searchProducts(request.term, search_fields);
                    response(results);
                },
                minLength: 2,
                response: function(event, ui) {
                    // auto-select if single result
                    if (ui.content.length == 1) {
                        ui.item = ui.content[0];

                        var is_overselling_allowed = $('input#is_overselling_allowed').length > 0;
                        var for_so = $('#sale_type').length && $('#sale_type').val() == 'sales_order';

                        if ((ui.item.enable_stock == 1 && ui.item.qty_available > 0) || 
                                (ui.item.enable_stock == 0) || is_overselling_allowed || for_so) {
                            $(this)
                                .data('ui-autocomplete')
                                ._trigger('select', 'autocompleteselect', ui);
                            $(this).autocomplete('close');
                        }
                    } else if (ui.content.length == 0) {
                        if (typeof LANG !== 'undefined' && LANG.no_products_found) {
                            toastr.error(LANG.no_products_found);
                        } else {
                            toastr.error('No products found');
                        }
                        $('input#search_product').select();
                    }
                },
                focus: function(event, ui) {
                    // Prevent focus on out-of-stock items
                    if (ui.item.qty_available <= 0) {
                        return false;
                    }
                },
                select: function(event, ui) {
                    var searched_term = $(this).val();
                    var is_overselling_allowed = $('input#is_overselling_allowed').length > 0;
                    var for_so = $('#sale_type').length && $('#sale_type').val() == 'sales_order';
                    var is_draft = $('input#status').length && 
                        ($('input#status').val() == 'quotation' || $('input#status').val() == 'draft');

                    if (ui.item.enable_stock != 1 || ui.item.qty_available > 0 || is_overselling_allowed || for_so || is_draft) {
                        $(this).val(null);

                        // Pre-select lot number if searched term matches lot number
                        var purchase_line_id = ui.item.purchase_line_id && searched_term == ui.item.lot_number ? ui.item.purchase_line_id : null;
                        
                        pos_product_row(ui.item.variation_id, purchase_line_id);
                    } else {
                        if (typeof LANG !== 'undefined' && LANG.out_of_stock) {
                            alert(LANG.out_of_stock);
                        } else {
                            alert('Out of stock');
                        }
                    }
                }
            }).autocomplete('instance')._renderItem = function(ul, item) {
                var is_overselling_allowed = $('input#is_overselling_allowed').length > 0;
                var for_so = $('#sale_type').length && $('#sale_type').val() == 'sales_order';
                var is_draft = $('input#status').length && 
                    ($('input#status').val() == 'quotation' || $('input#status').val() == 'draft');

                // global formatting functions
                const formatCurrency = window.POS_FormatHelpers.formatCurrency;
                const formatQuantity = window.POS_FormatHelpers.formatQuantity;

                if (item.enable_stock == 1 && item.qty_available <= 0 && !is_overselling_allowed && !for_so && !is_draft) {
                    // Out of stock item
                    var string = '<li class="ui-state-disabled">' + item.name;
                    if (item.type == 'variable' && item.variation) {
                        string += '-' + item.variation;
                    }
                    
                    var selling_price = item.variation_group_price || item.selling_price;
                    string += ' (' + item.sub_sku + ')' + '<br> Price: ' + formatCurrency(selling_price) + ' (Out of stock) </li>';
                    return $(string).appendTo(ul);
                } else {
                    // Available item
                    var string = '<div>' + item.name;
                    if (item.type == 'variable' && item.variation) {
                        string += '-' + item.variation;
                    }

                    var selling_price = item.variation_group_price || item.selling_price;
                    string += ' (' + item.sub_sku + ')' + '<br> Price: ' + formatCurrency(selling_price);
                    
                    if (item.enable_stock == 1 && item.qty_available !== 999999) {
                        var qty_available = yh(item.qty_available);
                        string += ' - ' + qty_available + ' ' + item.unit;
                    }
                    string += '</div>';

                    return $('<li>').append(string).appendTo(ul);
                }
            };

            }
        } else {
           //
        }

        // Handle price group changes - reset form and update prices
        // Exclude reset_form events to prevent interference during form resets
        $(document).on('change', 'select#price_group', function(e) {
            // Skip if this is triggered by reset_form to prevent loops
            if (e.namespace === 'reset_form') {
                return;
            }
            var selectedValue = $(this).val();
            var selectedText = $(this).find('option:selected').text();
            
            // Update hidden field
            $('input#hidden_price_group').val(selectedValue);
            
            // Skip the form reset if this is triggered by customer group selection
            if (e.namespace === 'customer_group_update') {
                return;
            }
            
            // Skip if customer selection is in progress to prevent interference
            if (window.pos_customer_selection_in_progress) {
                console.log('Price group change skipped - customer selection in progress');
                return;
            }
            
            // Check if we have products in cart before resetting
            if ($('table#pos_table tbody tr.product_row').length > 0) {
                // Set flag to indicate this reset is triggered by customer/price group change
                window.pos_customer_selection_triggered_reset = true;
                
                // Reset the POS form to clear existing products with old prices
                reset_pos_form();
                
                // Customer and price group restoration is now handled in reset_pos_form
                
                // Show notification about price change
                if (typeof toastr !== 'undefined') {
                    toastr.info('Price group changed to: ' + selectedText + '. Cart has been cleared.');
                }
            }
        });
        // Initialize cache
        var locationId = $('input#location_id').val();
        if (locationId) {
            POS_InstantCache.initialize(locationId).then(() => {
            });
        }

        // Unbind the legacy customer selection handler to prevent conflicts
        $('#customer_id').off('select2:select');
        console.log('Legacy customer selection handler unbound');
        
        // Add customer selection event handler for automatic price group setting
        $(document).on('select2:select', '#customer_id', function(e) {
            var data = e.params.data;
            console.log('NEW customer selection event triggered:', data);
            
            // Skip processing if we're in restoration mode
            if (window.pos_customer_restoration_in_progress) {
                console.log('Skipping customer selection processing - restoration in progress');
                return;
            }
            
            // Set flag to prevent price group change handler from interfering
            window.pos_customer_selection_in_progress = true;
            
            // Stop event propagation to prevent legacy pos.js handler from interfering
            e.stopImmediatePropagation();
            
            // Check if there are products in cart that need price updates
            var hasProductsInCart = $('table#pos_table tbody tr.product_row').length > 0;
            
            if (hasProductsInCart) {
                console.log('Products in cart detected - will clear cart for new customer pricing');
                // Store customer data for restoration after reset
                window.pos_selected_customer_data = {
                    id: data.id,
                    text: data.text,
                    price_calculation_type: data.price_calculation_type,
                    selling_price_group_id: data.selling_price_group_id,
                    discount_percent: data.discount_percent
                };
                
                // Set the new customer pricing first
                if (data.price_calculation_type == 'selling_price_group') {
                    $('#price_group').val(data.selling_price_group_id);
                    $('input#hidden_price_group').val(data.selling_price_group_id);
                    // Trigger change to update group prices
                    $('#price_group').trigger('change.customer_group_update');
                    window.pos_customer_group_discount = 0;
                } else if (data.price_calculation_type == 'percentage' && data.discount_percent) {
                    $('#price_group').val('0');
                    $('input#hidden_price_group').val('0');
                    // Trigger change to reset group prices  
                    $('#price_group').trigger('change.customer_group_update');
                    window.pos_customer_group_discount = Math.abs(parseFloat(data.discount_percent)) || 0;
                } else {
                    $('#price_group').val('0');
                    $('input#hidden_price_group').val('0');
                    // Trigger change to reset group prices
                    $('#price_group').trigger('change.customer_group_update');
                    window.pos_customer_group_discount = 0;
                }
                
                // Handle other customer data from legacy handler  
                if (data.pay_term_number) {
                    $('input#pay_term_number').val(data.pay_term_number);
                } else {
                    $('input#pay_term_number').val('');
                }

                if (data.pay_term_type) {
                    $('#add_sell_form select[name="pay_term_type"]').val(data.pay_term_type);
                    $('#edit_sell_form select[name="pay_term_type"]').val(data.pay_term_type);
                } else {
                    $('#add_sell_form select[name="pay_term_type"]').val('');
                    $('#edit_sell_form select[name="pay_term_type"]').val('');
                }
                
                if (typeof update_shipping_address === 'function') {
                    update_shipping_address(data);
                }
                
                $('#advance_balance_text').text(__currency_trans_from_en(data.balance), true);
                $('#advance_balance').val(data.balance);
                
                if ($('.contact_due_text').length) {
                    get_contact_due(data.id);
                }
                
                // Handle reward points functionality from legacy handler  
                var default_customer_id = $('#default_customer_id').val();
                if (data.id == default_customer_id) {
                    // Disable reward points for walk-in customers
                    if ($('#rp_redeemed_modal').length) {
                        $('#rp_redeemed_modal').val('');
                        $('#rp_redeemed_modal').trigger('change');
                        $('#rp_redeemed_modal').attr('disabled', true);
                        $('#available_rp').text('');
                        if (typeof updateRedeemedAmount === 'function') {
                            updateRedeemedAmount();
                        }
                        if (typeof pos_total_row === 'function') {
                            pos_total_row();
                        }
                    }
                } else {
                    // Enable reward points for non-walk-in customers
                    if ($('#rp_redeemed_modal').length) {
                        $('#rp_redeemed_modal').removeAttr('disabled');
                    }
                    // Skip getCustomerRewardPoints() call to prevent form interference
                    // getCustomerRewardPoints() causes form resets, handle reward points differently if needed
                    console.log('Skipping getCustomerRewardPoints() to prevent form reset');
                }
                
                // Skip get_sales_orders() call temporarily to prevent potential interference
                // get_sales_orders() might cause issues, test without it first
                console.log('Skipping get_sales_orders() to prevent potential issues');
                
                // Allow the form reset to clear old products with wrong prices
                window.pos_processing_customer_group = false;
                
                // Reset the cart to clear products with old prices
                // Customer restoration will be handled by reset_pos_form 
                reset_pos_form();
                
            } else {
                // No products in cart - just update customer pricing without reset
                console.log('No products in cart - updating customer pricing without reset');
                
                // Set flag to prevent any unwanted resets
                window.pos_processing_customer_group = true;
                
                // Store the customer data
                window.pos_selected_customer_data = {
                    id: data.id,
                    text: data.text,
                    price_calculation_type: data.price_calculation_type,
                    selling_price_group_id: data.selling_price_group_id,
                    discount_percent: data.discount_percent
                };
                
                // Handle customer group pricing like legacy handler
                if (data.price_calculation_type == 'selling_price_group') {
                    console.log('Customer selected with selling price group:', data.selling_price_group_id);
                    $('#price_group').val(data.selling_price_group_id);
                    $('input#hidden_price_group').val(data.selling_price_group_id);
                    // Trigger change like legacy handler does
                    $('#price_group').trigger('change');
                    window.pos_customer_group_discount = 0;
                    
                } else if (data.price_calculation_type == 'percentage' && data.discount_percent) {
                    console.log('Customer selected with group discount:', data.discount_percent + '%');
                    $('#price_group').val('0');
                    $('input#hidden_price_group').val('0');
                    // Trigger change like legacy handler does  
                    $('#price_group').trigger('change');
                    window.pos_customer_group_discount = Math.abs(parseFloat(data.discount_percent)) || 0;
                    
                } else {
                    console.log('Customer selected with no special pricing');
                    $('#price_group').val('0');
                    $('input#hidden_price_group').val('0');
                    // Trigger change like legacy handler does
                    $('#price_group').trigger('change');
                    window.pos_customer_group_discount = 0;
                }
                
                console.log('Customer group discount set to:', window.pos_customer_group_discount);
                
                // Handle other customer data from legacy handler
                if (data.pay_term_number) {
                    $('input#pay_term_number').val(data.pay_term_number);
                } else {
                    $('input#pay_term_number').val('');
                }

                if (data.pay_term_type) {
                    $('#add_sell_form select[name="pay_term_type"]').val(data.pay_term_type);
                    $('#edit_sell_form select[name="pay_term_type"]').val(data.pay_term_type);
                } else {
                    $('#add_sell_form select[name="pay_term_type"]').val('');
                    $('#edit_sell_form select[name="pay_term_type"]').val('');
                }
                
                if (typeof update_shipping_address === 'function') {
                    update_shipping_address(data);
                }
                
                $('#advance_balance_text').text(__currency_trans_from_en(data.balance), true);
                $('#advance_balance').val(data.balance);
                
                if ($('.contact_due_text').length) {
                    get_contact_due(data.id);
                }
                
                // Handle reward points functionality from legacy handler
                var default_customer_id = $('#default_customer_id').val();
                if (data.id == default_customer_id) {
                    // Disable reward points for walk-in customers
                    if ($('#rp_redeemed_modal').length) {
                        $('#rp_redeemed_modal').val('');
                        $('#rp_redeemed_modal').trigger('change');
                        $('#rp_redeemed_modal').attr('disabled', true);
                        $('#available_rp').text('');
                        if (typeof updateRedeemedAmount === 'function') {
                            updateRedeemedAmount();
                        }
                        if (typeof pos_total_row === 'function') {
                            pos_total_row();
                        }
                    }
                } else {
                    // Enable reward points for non-walk-in customers
                    if ($('#rp_redeemed_modal').length) {
                        $('#rp_redeemed_modal').removeAttr('disabled');
                    }
                    // Skip getCustomerRewardPoints() call to prevent form interference
                    // getCustomerRewardPoints() causes form resets, handle reward points differently if needed
                    console.log('Skipping getCustomerRewardPoints() to prevent form reset');
                }
                
                // Skip get_sales_orders() call temporarily to prevent potential interference
                // get_sales_orders() might cause issues, test without it first
                console.log('Skipping get_sales_orders() to prevent potential issues');
                
                // Clear the processing flag
                setTimeout(function() {
                    window.pos_processing_customer_group = false;
                    window.pos_customer_selection_in_progress = false;
                    console.log('Customer group processing flag cleared');
                }, 1000);
            }
            
            // Clear customer selection flag after some delay to allow legacy handler to complete
            setTimeout(function() {
                window.pos_customer_selection_in_progress = false;
                console.log('Customer selection completed');
            }, 2000);
        });
        
        // Also block the legacy change event handler for customer_id to prevent reward points interference
        // $(document).on('change', 'select#customer_id', function(e) {
        //     // Always block if customer restoration is in progress
        //     if (window.pos_customer_restoration_in_progress) {
        //         console.log('Blocking customer change event - restoration in progress');
        //         e.stopImmediatePropagation();
        //         return false;
        //     }
            
        //    // console.log('Blocking legacy customer change event to prevent interference');
        //    // e.stopImmediatePropagation();
        //     return false;
        // });

        // Listen for successful payment/sale completion
        $(document).on('pos_sale_completed', function(e, data) {
            POS_InstantCache.forceRefresh();
        });

        // Also listen for common POS events that might indicate sale completion
        if (typeof window.finalizeSale === 'function') {
            const originalFinalizeSale = window.finalizeSale;
            window.finalizeSale = function() {
                const result = originalFinalizeSale.apply(this, arguments);
                
                // Refresh cache after sale is finalized
                setTimeout(() => {
                    POS_InstantCache.forceRefresh();
                }, 1000);
                
                return result;
            };
        }

        // Listen for successful AJAX responses that might indicate sale completion
        $(document).ajaxSuccess(function(event, xhr, settings) {
            // Check if this was a sale completion request to POST /pos
            if (settings.url && settings.type === 'POST' && (
             
                settings.url.endsWith('/pos')
               
            )) {
                
                // Check if response indicates success
                try {
                    const response = JSON.parse(xhr.responseText);
                    // Only trigger on actual success (success: 1 or success: true, NOT success: 0)
                    if ((response.success === 1 || response.success === true) || response.status === 'success') {
                        setTimeout(() => {
                            POS_InstantCache.forceRefresh();
                          
                        }, 1000);
                        // Set flag to prevent customer restoration during AJAX-triggered reset
                        window.pos_ajax_triggered_reset = true;
                        set_default_customer();
                    } else {
                        console.log('Sale failed (success: 0) - not resetting customer or refreshing cache');
                    }
                } catch (e) {
                    // Only fallback to status code if we can't parse response
                    // But be more cautious - don't assume 200 means success if we have unparseable response
                    console.log('Could not parse response, not triggering reset to be safe');
                }
            }
        });

        // Add lot number change event handler
        $(document).on('change', 'select.lot_number', function() {
            var qty_available = parseFloat($(this).find('option:selected').data('qty_available')) || 0;
            var selected_lot_id = $(this).val();
            var selected_text = $(this).find('option:selected').text();
            var exp_date_str = $(this).find('option:selected').data('exp_date');
            var row = $(this).closest('tr');
            var qty_input = row.find('.pos_quantity');
            var current_qty = parseFloat(qty_input.val()) || 0;
            var variation_id = row.find('.row_variation_id').val();
            
            // Debug log for lot number selection
            console.log('Lot number changed - ID:', selected_lot_id, 'Text:', selected_text, 'Qty Available:', qty_available, 'Exp Date:', exp_date_str);
            console.log('Row variation_id:', variation_id, 'Type:', typeof variation_id);
            
            // Frontend validation for stop selling period
            if (selected_lot_id && exp_date_str) {
                var validation_result = window.validateLotStopSellingPeriod(exp_date_str, selected_text);
                if (!validation_result.valid) {
                    // Show warning and optionally prevent selection
                    if (typeof toastr !== 'undefined') {
                        toastr.warning(validation_result.message);
                    } else {
                        alert(validation_result.message);
                    }
                    console.warn('Lot validation failed:', validation_result.message);
                    
                    // Optionally reset to default selection
                    // $(this).val('').trigger('change.select2');
                    // return false;
                }
            }
            
            // Get original product stock for comparison
            var product_data = null;
            if (variation_id) {
                // Use the existing getProduct method directly
                product_data = POS_InstantCache.getProduct(variation_id);
                console.log('Looking for variation_id:', variation_id, 'Found product_data:', !!product_data);
                
                if (!product_data) {
                    console.error('Cannot find product data for variation_id:', variation_id);
                    console.log('This will cause issues with stock display updates');
                    return; // Don't proceed if we can't get product data
                }
            }
            
            if (!product_data) {
                console.error('Product data is required for lot selection handling');
                return;
            }
            
            // Determine effective stock based on lot selection
            var effective_stock = 0;
            var validation_message = '';
            
            if (selected_lot_id && qty_available > 0) {
                // Lot selected with stock available - use lot quantity
                effective_stock = qty_available;
                validation_message = $(this).find('option:selected').data('msg-max') || 
                    POS_RowGenerator.lang('validation.custom-messages.quantity_not_available')
                        .replace(':qty', POS_RowGenerator.format_quantity(qty_available))
                        .replace(':unit', product_data ? product_data.unit : 'unit');
                
                console.log('Lot selected: Using lot stock', effective_stock);
            } else if (selected_lot_id && qty_available <= 0) {
                // Lot selected but no stock - block selling
                effective_stock = 0;
                validation_message = POS_RowGenerator.lang('lang_v1.item_out_of_stock');
                console.log('Lot selected but out of stock');
            } else if (!selected_lot_id && product_data) {
                // No lot selected - for lot-only products, use original_qty_available (should be 0)
                // This forces lot selection for products that only have lot-based stock
                effective_stock = parseFloat(product_data.original_qty_available !== undefined ? product_data.original_qty_available : product_data.qty_available || 0);
                validation_message = POS_RowGenerator.lang('validation.custom-messages.quantity_not_available')
                    .replace(':qty', POS_RowGenerator.format_quantity(effective_stock))
                    .replace(':unit', product_data.unit || 'unit');
                
                console.log('No lot selected: Using original stock for lot-only products', effective_stock);
            }
            
            // Update quantity validation based on effective stock
            if (effective_stock > 0) {
                qty_input.attr('data-rule-max-value', effective_stock);
                qty_input.attr('data-msg-max-value', validation_message);
                qty_input.removeAttr('disabled');
                
                // Refresh validation rules
                qty_input.rules('remove', 'max-value');
                qty_input.rules('add', {
                    'max-value': effective_stock,
                    messages: {
                        'max-value': validation_message
                    }
                });
                
                // If current quantity exceeds effective stock, reset to maximum available
                if (current_qty > effective_stock) {
                    qty_input.val(POS_RowGenerator.format_quantity(effective_stock));
                    qty_input.trigger('change');
                }
            } else {
                // No stock available - disable quantity input or set to 0
                qty_input.attr('data-rule-max-value', 0);
                qty_input.attr('data-msg-max-value', validation_message);
                
                // Refresh validation rules with max 0
                qty_input.rules('remove', 'max-value');
                qty_input.rules('add', {
                    'max-value': 0,
                    messages: {
                        'max-value': validation_message || POS_RowGenerator.lang('lang_v1.item_out_of_stock')
                    }
                });
                
                if (current_qty > 0) {
                    qty_input.val('0');
                    qty_input.trigger('change');
                }
                console.log('No stock available - quantity set to 0');
            }
            
            // Force validation check on current value
            qty_input.valid();
            
            // Update stock display dynamically
            try {
                POS_RowGenerator.updateStockDisplay(row, selected_lot_id, qty_available, selected_text, product_data);
            } catch (error) {
                console.error('Error updating stock display:', error);
            }
            
            // Trigger validation check
            qty_input.valid();
        });

    }, 1000);
});

window.refreshPOSCache = function() {
    return POS_InstantCache.forceRefresh();
};

// Frontend validation for lot stop selling period
window.validateLotStopSellingPeriod = function(exp_date_str, lot_text) {
    if (!exp_date_str) {
        return { valid: true, message: '' };
    }
    
    // Check if stop selling on expiry is enabled (matching backend logic)
    var business = window.POS_InstantCache && window.POS_InstantCache.business;
    
    // Handle boolean values from checkbox (true/false) as well as integer values (1/0)
    var expiry_enabled = business && (business.enable_product_expiry === true || business.enable_product_expiry == 1);
    var stop_selling_enabled = expiry_enabled && business.on_product_expiry == 'stop_selling';
    var stop_selling_days = 0;
    
    console.log('Expiry settings check:');
    console.log('- enable_product_expiry:', business && business.enable_product_expiry, '(type:', typeof(business && business.enable_product_expiry), ')');
    console.log('- on_product_expiry:', business && business.on_product_expiry, '(type:', typeof(business && business.on_product_expiry), ')');
    console.log('- expiry_enabled:', expiry_enabled);
    console.log('- stop_selling_enabled:', stop_selling_enabled);
    
    if (stop_selling_enabled) {
        console.log('Stop selling on expiry is enabled');
        
        // Look for stop_selling_before days setting
        if (business.stop_selling_before) {
            stop_selling_days = parseInt(business.stop_selling_before) || 0;
            console.log('Using stop selling days from business settings:', stop_selling_days);
        }
    } else if (expiry_enabled && (!business.on_product_expiry || business.on_product_expiry === undefined)) {
        console.log('Product expiry is enabled but on_product_expiry setting is missing/undefined. Please check business settings.');
        // Optionally treat undefined as 'keep_selling' (default behavior)
        console.log('Treating undefined on_product_expiry as keep_selling (allow sales)');
    } else if (business) {
        console.log('Stop selling on expiry is disabled - enable_product_expiry:', business.enable_product_expiry, 'on_product_expiry:', business.on_product_expiry);
    } else {
        console.log('Business settings not available in cache');
    }
    
    // No manual fallback - only use system settings from backend
    console.log('Stop selling validation result - enabled:', stop_selling_enabled, 'days:', stop_selling_days);
    
    if (!stop_selling_enabled) {
        return { valid: true, message: '' }; // Stop selling is disabled
    }
    
    if (stop_selling_days <= 0) {
        // If stop selling is enabled but no days specified, check if product is actually expired
        var exp_date = new Date(exp_date_str);
        var current_date = new Date();
        
        if (current_date > exp_date) {
            return {
                valid: false,
                message: `Cannot sell ${lot_text || 'this lot'}. Product has expired on ${exp_date_str}.`
            };
        }
        return { valid: true, message: '' }; // Not expired yet
    }
    
    try {
        var exp_date = new Date(exp_date_str);
        var current_date = new Date();
        
        // Calculate the stop selling date
        var stop_selling_date = new Date(exp_date);
        stop_selling_date.setDate(stop_selling_date.getDate() - stop_selling_days);
        
        var days_until_expiry = Math.ceil((exp_date - current_date) / (1000 * 60 * 60 * 24));
        
        if (current_date >= stop_selling_date) {
            return {
                valid: false,
                message: `Cannot sell ${lot_text || 'this lot'}. Stop selling period reached (${stop_selling_days} days before expiry). Expires in ${days_until_expiry} day(s).`
            };
        }
        
        // Optional: warn when approaching stop selling period (within 1 day)
        var warning_date = new Date(stop_selling_date);
        warning_date.setDate(warning_date.getDate() + 1);
        if (current_date >= warning_date) {
            console.info(`Warning: ${lot_text || 'Lot'} will enter stop selling period soon. Expires in ${days_until_expiry} day(s).`);
        }
        
        return { valid: true, message: '' };
        
    } catch (e) {
        console.error('Error validating lot expiry:', e);
        return { valid: true, message: '' }; // Allow on error to avoid blocking valid operations
    }
};

$(document).ready(function() {
    // Debug: Show available cache data to find stop selling setting
    setTimeout(function() {
        if (window.POS_InstantCache && window.POS_InstantCache.initialized) {
            console.log('=== POS Cache Debug Info ===');
            console.log('Business settings:', window.POS_InstantCache.business);
            
            // Check expiry and stop selling configuration
            if (window.POS_InstantCache.business) {
                var business = window.POS_InstantCache.business;
                console.log('=== Expiry Settings ===');
                console.log('enable_product_expiry:', business.enable_product_expiry, '(type:', typeof business.enable_product_expiry, ')');
                console.log('on_product_expiry:', business.on_product_expiry, '(type:', typeof business.on_product_expiry, ')');
                console.log('stop_selling_before:', business.stop_selling_before, '(type:', typeof business.stop_selling_before, ')');
                
                // Show all available business keys to debug what's missing
                console.log('Available business settings keys:', Object.keys(business));
                
                var expiry_enabled = (business.enable_product_expiry === true || business.enable_product_expiry == 1);
                var stop_selling_enabled = expiry_enabled && business.on_product_expiry == 'stop_selling';
                console.log('expiry_enabled:', expiry_enabled);
                console.log('Stop selling enabled:', stop_selling_enabled);
                
                if (stop_selling_enabled && business.stop_selling_before) {
                    console.log('Will stop selling', business.stop_selling_before, 'days before expiry');
                } else if (stop_selling_enabled) {
                    console.log('Will stop selling only when actually expired (no days before)');
                } else {
                    console.log('Stop selling is disabled or missing settings');
                    
                    // Debug missing settings
                    if (!expiry_enabled) {
                        console.log('Reason: Product expiry not enabled');
                    } else if (business.on_product_expiry !== 'stop_selling') {
                        console.log('Reason: on_product_expiry is not "stop_selling", got:', business.on_product_expiry);
                    }
                }
            }
            console.log('=== End Cache Debug ===');
        }
    }, 3000);
    
    // Stop selling validation will only use backend system settings
    // No manual configuration needed
    
    setTimeout(function() {
        const possibleContainers = [
            '.pos-processing',
            '.pos-header',
            '.pos-controls',
            '#pos_table_div',
            '.box-header'
        ];
        
        let buttonAdded = false;
        possibleContainers.forEach(selector => {
            if (!buttonAdded && $(selector).length > 0) {
                $(selector).first().append(`
                    <button type="button" class="btn btn-sm btn-info" onclick="refreshPOSCache()" title="Refresh Product Cache" style="margin: 5px;">
                        <i class="fa fa-refresh"></i> Refresh Cache
                    </button>
                `);
                buttonAdded = true;
            }
        });
        
        // Initialize modifier handlers
        if (typeof POS_RowGenerator !== 'undefined' && POS_RowGenerator.initializeModifierHandlers) {
            POS_RowGenerator.initializeModifierHandlers();
        }
        
    }, 2000);
});
